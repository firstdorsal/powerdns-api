image: node:latest

stages:
  - makedoc
#  - publish

makedoc:
  stage: makedoc
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/privkey
    - chmod 600 ~/.ssh/privkey
    - ssh-keyscan -p '30022' -H 'git.y.gy' >> ~/.ssh/known_hosts
    - |
      echo "Host git.y.gy
          Port 30022
          Preferredauthentications publickey
          IdentityFile ~/.ssh/privkey
      " > ~/.ssh/config
  script:
    - npm install docdash-orange jsdoc jsdoc-to-markdown
    - cat README_basic.md > README.md
    - node_modules/.bin/jsdoc2md index.js >> README.md
    - node_modules/.bin/jsdoc index.js -t node_modules/docdash-orange --readme README_basic.md
    - git config --global user.email "runner@$CI_SERVER_HOST"
    - git config --global user.name "runner"
    - git remote remove origin
    - git remote add origin ssh://git@git.y.gy/firstdorsal/$CI_PROJECT_NAME.git
    - git commit README.md -m "ğŸ¤– makedoc [skip ci]"
    - git checkout -b master
    - git push --set-upstream origin master
#publish:
#  stage: publish
#  script:
#    - echo '//registry.npmjs.org/:_authToken=${NPM_TOKEN}'>.npmrc
#    - npm publish
